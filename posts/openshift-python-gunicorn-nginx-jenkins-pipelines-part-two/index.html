<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=yandex-verification content="3ccce49727df78e2"><title>Writing Jenkins Pipeline For OpenShift Deployment</title><meta name=description content="This article is the second one of three-parts series regarding CI/CD of Python Application using Gunicorn, NGINX, Jenkins Pipeline to OpenShift. In series, we will be explaining:"><link rel=preload href=/fonts/pt-serif-400-i-latin-ext.woff2 as=font><link rel=preload href=/fonts/pt-sans-400-latin-ext.woff2 as=font><link rel=preload href=/fonts/pt-serif-700-i-latin-ext.woff2 as=font><link rel=preload href=/fonts/pt-serif-700-i-cyrillic.woff2 as=font><link rel=preload href=/fonts/pt-serif-700-cyrillic.woff2 as=font><link rel=preload href=/fonts/pt-serif-400-i-cyrillic.woff2 as=font><link rel=preload href=/fonts/pt-sans-700-cyrillic.woff2 as=font><link rel=preload href=/fonts/pt-serif-700-cyrillic-ext.woff2 as=font><link rel=preload href=/fonts/pt-sans-700-i-latin-ext.woff2 as=font><link rel=preload href=/fonts/pt-sans-700-i-cyrillic.woff2 as=font><link rel=preload href=/fonts/pt-sans-400-i-latin-ext.woff2 as=font><link rel=preload href=/fonts/pt-serif-700-latin.woff2 as=font><link rel=preload href=/fonts/pt-serif-700-i-latin.woff2 as=font><link rel=preload href=/fonts/pt-serif-400-latin.woff2 as=font><link rel=preload href=/fonts/pt-sans-700-latin-ext.woff2 as=font><link rel=preload href=/fonts/pt-sans-400-i-cyrillic.woff2 as=font><link rel=preload href=/fonts/pt-sans-700-cyrillic-ext.woff2 as=font><link rel=preload href=/fonts/pt-sans-400-i-latin.woff2 as=font><link rel=preload href=/fonts/pt-sans-700-latin.woff2 as=font><link rel=preload href=/fonts/pt-sans-400-i-cyrillic-ext.woff2 as=font><link rel=preload href=/fonts/pt-sans-400-cyrillic-ext.woff2 as=font><link rel=preload href=/fonts/pt-serif-400-latin-ext.woff2 as=font><link rel=preload href=/fonts/pt-sans-400-latin.woff2 as=font><link rel=preload href=/fonts/pt-sans-700-i-cyrillic-ext.woff2 as=font><link rel=preload href=/fonts/pt-serif-400-cyrillic-ext.woff2 as=font><link rel=preload href=/fonts/pt-serif-700-latin-ext.woff2 as=font><link rel=preload href=/fonts/pt-serif-400-i-latin.woff2 as=font><link rel=preload href=/fonts/pt-sans-700-i-latin.woff2 as=font><link rel=preload href=/fonts/pt-serif-400-i-cyrillic-ext.woff2 as=font><link rel=preload href=/fonts/pt-sans-400-cyrillic.woff2 as=font><link rel=preload href=/fonts/pt-serif-700-i-cyrillic-ext.woff2 as=font><link rel=preload href=/fonts/pt-serif-400-cyrillic.woff2 as=font><link rel=stylesheet href=https://ruddra.com/css/bundle.min.83282dee17ffeb42aa041e5c8db7e9179eda66c3b8ee7dcd9432b4aa81058ef8.css integrity="sha256-gygt7hf/60KqBB5cjbfpF57aZsO47n3NlDK0qoEFjvg=" async><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon.png><link rel="shortcut icon" href=/favicon.ico><link rel=alternate type=application/rss+xml title=RSS href=/sitemap.xml><meta name=generator content="Hugo 0.64.0"><meta name=twitter:card content="summary_large_image"><meta name=robots content="max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="Ruddra.com | Blog by Arnab Kumar Shil"><meta property="article:publisher" content="https://ruddra.com"><meta property="article:section" content="Bulletin"><meta property="article:published_time" content="2018-08-11T00:00:00.00Z"><meta property="article:modified_time" content="2020-04-17T00:00:00.00Z"><meta property="og:updated_time" content="2020-04-17T00:00:00.00Z"><meta property="og:image" content="https://ruddra.com/content/images/2020/04/pipeline.jpg"><meta property="og:image:secure_url" content="https://ruddra.com/content/images/2020/04/pipeline.jpg"><meta property="og:image:width" content="720"><meta property="og:image:height" content="350"><meta name=twitter:title content="Writing Jenkins Pipeline For OpenShift Deployment"><meta name=twitter:description content="This article is the second one of three-parts series regarding CI/CD of Python Application using Gunicorn, NGINX, Jenkins Pipeline to OpenShift. In series, we will be explaining:"><meta property="og:type" content="article"><meta property="og:title" content="Writing Jenkins Pipeline For OpenShift Deployment"><meta property="og:description" content="This article is the second one of three-parts series regarding CI/CD of Python Application using Gunicorn, NGINX, Jenkins Pipeline to OpenShift. In series, we will be explaining:"><meta name=twitter:image content="https://ruddra.com/content/images/2020/04/pipeline.jpg"><meta property="og:image" content="https://ruddra.com/content/images/2020/04/pipeline.jpg"><meta property="article:tag" content="openshift"><meta property="article:tag" content="jenkins"><meta property="article:tag" content="pipeline"><meta property="article:tag" content="ci/cd"><meta property="article:tag" content="ruddra"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"posts","mainEntityOfPage":"https:\/\/ruddra.com\/posts\/openshift-python-gunicorn-nginx-jenkins-pipelines-part-two\/","identifier":"https:\/\/ruddra.com\/posts\/openshift-python-gunicorn-nginx-jenkins-pipelines-part-two\/","author":{"@type":"Person","name":"Arnab Kumar Shil","url":"https:\/\/ruddra.com/info/about/"},"logo":"https:\/\/ruddra.com\/favicon-32x32.png","name":"Writing Jenkins Pipeline For OpenShift Deployment","headline":"Writing Jenkins Pipeline For OpenShift Deployment","description":"This article is the second one of three-parts series regarding CI\/CD of Python Application using Gunicorn, NGINX, Jenkins Pipeline to OpenShift. In series, we will be explaining:","inLanguage":"en-US","creator":["Arnab Kumar Shil"],"accountablePerson":"Arnab Kumar Shil","copyrightHolder":"Arnab Kumar Shil","copyrightYear":"2018","dateCreated":"2018-08-11T00:00:00.00Z","datePublished":"2018-08-11T00:00:00.00Z","dateModified":"2020-04-17T00:00:00.00Z","url":"https:\/\/ruddra.com\/posts\/openshift-python-gunicorn-nginx-jenkins-pipelines-part-two\/","wordCount":"1933","publisher":{"@type":"Organization","name":"Ruddra.com | Blog by Arnab Kumar Shil","url":"https:\/\/ruddra.com","logo":"https:\/\/ruddra.com\/avatar.png"},"image":["https:\/\/ruddra.com\/content\/images\/2020\/04\/pipeline.jpg"],"keywords":["Tag:OpenShift","Tag:Jenkins","Tag:Pipeline","Tag:CI\/CD","Elevated:true","Tag:Blog"]}</script></head><body><div id=cover-spin></div><input type=checkbox class=sidebar-checkbox id=sidebar-checkbox><div class=sidebar id=sidebar><div class=sidebar-item><img src=/avatar.jpg decoding=async loading=lazy><p>Hi! I am Arnab, a full stack developer specializing in <b><a href=/tags/python/>Python</a></b>,
<b><a href=/tags/django/>Django</a></b>, <b><a href=/tags/docker/>Docker</a></b>, <b><a href=/tags/reactjs/>React</a></b>, <b><a href=/tags/openshift/>OpenShift</a></b>.</p><p class=sidebar-icons><a class=icon-side-bar href=https://stackoverflow.com/users/2696165/ruddra target=_blank rel="noopener me" title=stackoverflow><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="10 10 100 100" fill="currentcolor" class="feather"><path d="M84.4 93.8V70.6h7.7v30.9H22.6V70.6h7.7v23.2z"/><path d="M38.8 68.4l37.8 7.9 1.6-7.6-37.8-7.9-1.6 7.6zm5-18 35 16.3 3.2-7-35-16.4-3.2 7.1zm9.7-17.2 29.7 24.7 4.9-5.9-29.7-24.7-4.9 5.9zm19.2-18.3-6.2 4.6 23 31 6.2-4.6-23-31zM38 86h38.6v-7.7H38V86z"/></svg></a><a class=icon-side-bar href=https://github.com/ruddra target=_blank rel="noopener me" title=github><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a class=icon-side-bar href=https://www.linkedin.com/in/ruddraarnab target=_blank rel="noopener me" title=linkedin><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-linkedin"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a><a class=icon-side-bar href=https://medium.com/@ruddra target=_blank rel="noopener me" title=medium><svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd"><rect id="backgroundrect" width="100%" height="100%" x="0" y="0" fill="none" stroke="none"/><g class="currentLayer"><title>Layer 1</title><path d="M2.846 6.887c.03-.295-.083-.586-.303-.784l-2.24-2.7v-.403h6.958l5.378 11.795 4.728-11.795h6.633v.403l-1.916 1.837c-.165.126-.247.333-.213.538v13.498c-.034.204.048.411.213.537l1.871 1.837v.403h-9.412v-.403l1.939-1.882c.19-.19.19-.246.19-.537v-10.91l-5.389 13.688h-.728l-6.275-13.688v9.174c-.052.385.076.774.347 1.052l2.521 3.058v.404h-7.148v-.404l2.521-3.058c.27-.279.39-.67.325-1.052v-10.608z" id="svg_1" class="selected" opacity="1" fill="#fff" fill-opacity="1"/></g></svg></a><a class=icon-side-bar href=/posts/index.xml target=_blank rel="noopener me" title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></div><nav class=sidebar-nav><a class=sidebar-nav-item href=/>Home</a>
<a class=sidebar-nav-item href=/info/about/>About
Me</a>
<a class=sidebar-nav-item href=/info/privacy/>Privacy Policy</a><form class="sidebar-nav-item search-form" method=get action=/search><input type=text class=tftextinput name=q size=21 maxlength=120><button type=submit class=tfbutton><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="rgb(155,155,155)"><path d="M9.145 18.29c-5.042.0-9.145-4.102-9.145-9.145S4.103.0 9.145.0s9.145 4.103 9.145 9.145-4.102 9.145-9.145 9.145zm0-15.167c-3.321.0-6.022 2.702-6.022 6.022s2.702 6.022 6.022 6.022 6.023-2.702 6.023-6.022-2.702-6.022-6.023-6.022zm9.263 12.443c-.817 1.176-1.852 2.188-3.046 2.981l5.452 5.453 3.014-3.013-5.42-5.421z" /></svg></button></form></nav><div class=sidebar-item><p>&copy; 2020. All rights reserved.</p></div></div><div id=snackbar>By using our website, you agree to our <a href=/privacy>privacy policy</a> <a id=close-privacy>&#x2715;</a></div><div class=wrap><div class=masthead><div class=container><h3 class=masthead-title><a href=/ title=Home style=color:#cfcdcd>Ruddra</a><small style=color:#838383;font-size:1.25rem>.com</small></h3><form class="masthead-search-form pull-right" method=get action=/search><input type=text class=tftextinput name=q size=21 maxlength=120><button type=submit class=tfbutton><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="rgb(155,155,155)"><path d="M9.145 18.29c-5.042.0-9.145-4.102-9.145-9.145S4.103.0 9.145.0s9.145 4.103 9.145 9.145-4.102 9.145-9.145 9.145zm0-15.167c-3.321.0-6.022 2.702-6.022 6.022s2.702 6.022 6.022 6.022 6.023-2.702 6.023-6.022-2.702-6.022-6.023-6.022zm9.263 12.443c-.817 1.176-1.852 2.188-3.046 2.981l5.452 5.453 3.014-3.013-5.42-5.421z"/></svg></button></form></div></div><div class=progress-container><div class=progress-bar id=myBar></div></div><div class="container content"><div class=post><h1 class=post-title>Writing Jenkins Pipeline For OpenShift Deployment</h1><span class=post-date>Aug 11, 2018 &#183; 10 min read &#183;
0 comment</span><div class=img-container><img class=img-center src=https://ruddra.com/content/images/2020/04/pipeline.jpg alt="Writing Jenkins Pipeline For OpenShift Deployment"></div><div class=photo-credit>Photo by <a href=https://unsplash.com/@realaxer>tian kuan</a> on <a href=https://unsplash.com>Unsplash</a></div><div><p><a href=https://en.wikipedia.org/wiki/Pipeline_(computing)>Pipeline</a> is a set of instructions, which will be executed as per given sequence and produce a output. <a href=https://jenkins.io/doc/book/pipeline/>Jenkins Pipeline</a> is simply writing these instructions in Jenkins. These pipelines can be written in Groovy.</p><p>In <a href=https://ruddra.com/openshift-python-gunicorn-nginx-jenkins-pipelines-part-one>previous post</a> we have defined deployment structure and made necessary preparations for deployment of a python+gunicorn+nginx+jenkins based project. In this post, we will discuss about the most important part of our CI/CD project, writing jenkins pipeline. This pipeline will provide continuous delivery(CD) for our deployment.<div class=toc><h2 class=toc>Table of contents</h2><nav id=TableOfContents><ul><li><a href=#plan-for-pipeline>Plan for pipeline</a></li><li><a href=#steps>Steps</a><ul><li><a href=#step-0-declaring-agent-and-env-variables>Step 0: declaring agent and ENV variables</a></li><li><a href=#step-1-get-latest-code>Step 1: get latest code</a></li><li><a href=#step-2-install-dependencies>Step 2: install dependencies</a></li><li><a href=#step-3-run-tests>Step 3: run tests</a></li><li><a href=#step-4-storing-artifacts>Step 4: storing artifacts</a></li><li><a href=#step-5-create-build-configuration-in-openshift>Step 5: create build configuration in OpenShift</a></li><li><a href=#step-6-build-image>Step 6: build image</a></li><li><a href=#step-7-deploy-to-openshift-in-dev>Step 7: deploy to OpenShift in DEV</a></li><li><a href=#step-8-promote-image-to-stage>Step 8: promote image to STAGE</a></li><li><a href=#step-9-deploy-to-openshift-in-stage>Step 9: deploy to OpenShift in STAGE</a></li><li><a href=#step-10-scale-in-stage>Step 10: scale in STAGE</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></p><h2 id=plan-for-pipeline>Plan for pipeline<a href=#plan-for-pipeline class=hanchor arialabel=Anchor> <svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg>&#xFE0E;</a></h2><p>Our plan is to execute the following stages in serial order:</p><ol><li>Get Latest Code</li><li>Install Dependencies</li><li>Run Tests(and store them)</li><li>Store Artifacts</li><li>Create Build Configuration in OpenShift(DEV PROJECT)</li><li>Build in OpenShift(DEV PROJECT)</li><li>Create Deploy Configuration in OpenShift(DEV PROJECT)</li><li>Promote the image(to STAGE PROJECT)</li><li>Deploy to OpenShift(STAGE PROJECT)</li><li>Scale Up(in STAGE PROJECT)</li></ol><p>Stage 1-4 will be executed in Jenkins.Stage 5-10 will be executed in OpenShift. If you are feeling confused about these stages, don&rsquo;t worry. We will be explaining them one by one. Please keep in mind, with every stage there is a description of possible outcome of the execution of that stage. But in this article, our task is only to create a <strong>pipeline</strong>, not execute it.</p><h2 id=steps>Steps<a href=#steps class=hanchor arialabel=Anchor> <svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg>&#xFE0E;</a></h2><h3 id=step-0-declaring-agent-and-env-variables>Step 0: declaring agent and ENV variables<a href=#step-0-declaring-agent-and-env-variables class=hanchor arialabel=Anchor> <svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg>&#xFE0E;</a></h3><p>Stage Zero? Yep, this step is very important for writing pipeline. We will declare agent and environment variables in this step.
In Jenkins, we need to specify a <a href=https://jenkins.io/doc/book/pipeline/syntax/#agent>agent</a>, in which the pipeline will be executing. We will be using python jenkins slave to execute our pipeline. We will discuss more about jenkins python slave in <a href=https://ruddra.com/2018/08/12/openshift-python-gunicorn-nginx-jenkins-pipelines-part-three>next article</a>.
The python agent should look like this:</p><div class=highlight><pre class=chroma><code class=language-groovy data-lang=groovy><span class=n>pipeline</span> <span class=o>{</span>
    <span class=n>agent</span> <span class=o>{</span>
      <span class=n>node</span> <span class=o>{</span><span class=n>label</span> <span class=s1>&#39;python&#39;</span><span class=o>}</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>We can write down our constant values in environment variables. For example:</p><div class=highlight><pre class=chroma><code class=language-groovy data-lang=groovy><span class=n>environment</span> <span class=o>{</span>
    <span class=n>APPLICATION_NAME</span> <span class=o>=</span> <span class=s1>&#39;python-nginx&#39;</span>
    <span class=n>GIT_REPO</span><span class=o>=</span><span class=s2>&#34;http://github.com/ruddra/openshift-python-nginx.git&#34;</span>
    <span class=n>GIT_BRANCH</span><span class=o>=</span><span class=s2>&#34;master&#34;</span>
    <span class=n>STAGE_TAG</span> <span class=o>=</span> <span class=s2>&#34;promoteToQA&#34;</span>
    <span class=n>DEV_PROJECT</span> <span class=o>=</span> <span class=s2>&#34;dev&#34;</span>
    <span class=n>STAGE_PROJECT</span> <span class=o>=</span> <span class=s2>&#34;stage&#34;</span>
    <span class=n>TEMPLATE_NAME</span> <span class=o>=</span> <span class=s2>&#34;python-nginx&#34;</span>
    <span class=n>ARTIFACT_FOLDER</span> <span class=o>=</span> <span class=s2>&#34;target&#34;</span>
    <span class=n>PORT</span> <span class=o>=</span> <span class=mi>8081</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></div><p>Some variable declaration may seem confusing, but we will use them in next steps.</p><h3 id=step-1-get-latest-code>Step 1: get latest code<a href=#step-1-get-latest-code class=hanchor arialabel=Anchor> <svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg>&#xFE0E;</a></h3><p>Jenkins Pipeline execution is done in stages. All the stages of pipeline will be inside in one stages dictionary. Like:</p><div class=highlight><pre class=chroma><code class=language-groovy data-lang=groovy><span class=n>stages</span> <span class=o>{</span>
    <span class=n>stage</span><span class=o>(</span><span class=s2>&#34;One&#34;</span><span class=o>)</span><span class=o>{</span>
    <span class=c1>// Do Something
</span><span class=c1></span>    <span class=o>}</span>
    <span class=n>stage</span><span class=o>(</span><span class=s2>&#34;Two&#34;</span><span class=o>)</span><span class=o>{</span>
    <span class=c1>// Do Something
</span><span class=c1></span>    <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>In first stage, we will be using <a href=https://wiki.jenkins.io/display/JENKINS/Git+Plugin>Git Plugin</a> which comes as default with OpenShift Jenkins. We will be using following code for pulling the latest code:</p><div class=highlight><pre class=chroma><code class=language-groovy data-lang=groovy><span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Get Latest Code&#39;</span><span class=o>)</span> <span class=o>{</span>
  <span class=n>steps</span> <span class=o>{</span>
    <span class=n>git</span> <span class=nl>branch:</span> <span class=s2>&#34;${GIT_BRANCH}&#34;</span><span class=o>,</span> <span class=nl>url:</span> <span class=s2>&#34;${GIT_REPO}&#34;</span> <span class=c1>// declared in environment
</span><span class=c1></span>  <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><h3 id=step-2-install-dependencies>Step 2: install dependencies<a href=#step-2-install-dependencies class=hanchor arialabel=Anchor> <svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg>&#xFE0E;</a></h3><p>In this stage, we will install python dependencies inside in a <a href=https://virtualenv.pypa.io/en/stable/>virtual environment</a>. For that, we will first install <em>virtualenv</em> using <code>pip install virtualenv</code>. After activating the virtualenv, we will install the dependencies using <code>pip install -r requirements.pip</code> from dependencies defined in <strong>app>requirements.pip</strong>.</p><div class=highlight><pre class=chroma><code class=language-groovy data-lang=groovy><span class=n>stage</span><span class=o>(</span><span class=s2>&#34;Install Dependencies&#34;</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>steps</span> <span class=o>{</span>
        <span class=n>sh</span> <span class=s2>&#34;&#34;&#34;
</span><span class=s2>        pip install virtualenv
</span><span class=s2>        virtualenv --no-site-packages .
</span><span class=s2>        source bin/activate
</span><span class=s2>        pip install -r app/requirements.pip
</span><span class=s2>        deactivate
</span><span class=s2>        &#34;&#34;&#34;</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>Here we are using <a href=https://jenkins.io/doc/book/pipeline/syntax/#scripted-steps>steps</a> to execute the commands for installing dependencies.</p><h3 id=step-3-run-tests>Step 3: run tests<a href=#step-3-run-tests class=hanchor arialabel=Anchor> <svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg>&#xFE0E;</a></h3><p>In this stage, we will run tests, so that we can make sure if any test fails, pipeline does not execute any further. We will also store the test results using <a href=https://wiki.jenkins.io/display/JENKINS/JUnit+Plugin>JUnit Plugin</a>.</p><p>First, we will activate our virtualenv(again!!) then run tests in <strong>app</strong> directory using <em>nosetests</em>. It will export test results in xml format. Then we will store the result using <em>JUnit</em>.</p><div class=highlight><pre class=chroma><code class=language-groovy data-lang=groovy><span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Run Tests&#39;</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>steps</span> <span class=o>{</span>
        <span class=n>sh</span> <span class=s1>&#39;&#39;&#39;
</span><span class=s1>        source bin/activate
</span><span class=s1>        nosetests app --with-xunit
</span><span class=s1>        deactivate
</span><span class=s1>        &#39;&#39;&#39;</span>
        <span class=n>junit</span> <span class=s2>&#34;nosetests.xml&#34;</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><h3 id=step-4-storing-artifacts>Step 4: storing artifacts<a href=#step-4-storing-artifacts class=hanchor arialabel=Anchor> <svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg>&#xFE0E;</a></h3><p><a href=https://en.wikipedia.org/wiki/Artifact_(software_development)>Artifact</a> may sound weird to you if you are familliar with Java. Because we are working with Python, not Java builds. Python does not require any builds, still we are storing a compressed file consists of Python codes as well as our Dockerfile and NGINX configurations(<em>app</em>,<em>config</em>,<em>Dockerfile</em>), and we are going to use this compressed file to deploy our application to openshift. You might think that storing that file is not necessary, but I feel that storing that might be necessary, so that in later you can find out what is being pushed to openshift or if there is any discrepancy between what you want to deploy and what you are deploying.
Anyways, for this stage, we will make safe name for naming our compressed file. <code>BUILD_NUMBER</code> is an environment variable available in pipeline, which provides current <a href=https://qa.nuxeo.org/jenkins/pipeline-syntax/globals>build number</a> which should be unique per build. We will be using <strong>APPLICATION_NAME + BUILD_NUMBER</strong> to make a safe build name. We will store the Artifacts in a special directory, for now lets use <strong>target</strong> folder inside <a href=https://wiki.jenkins.io/display/JENKINS/Building+a+software+project>workspace</a>(Workspace is basically the place/path where the whole pipeline execution is happening).</p><div class=highlight><pre class=chroma><code class=language-groovy data-lang=groovy><span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Store Artifact&#39;</span><span class=o>)</span><span class=o>{</span>
  <span class=n>steps</span><span class=o>{</span>
      <span class=n>script</span><span class=o>{</span>
        <span class=kt>def</span> <span class=n>safeBuildName</span>  <span class=o>=</span> <span class=s2>&#34;${APPLICATION_NAME}_${BUILD_NUMBER}&#34;</span><span class=o>,</span>
            <span class=n>artifactFolder</span> <span class=o>=</span> <span class=s2>&#34;${ARTIFACT_FOLDER}&#34;</span><span class=o>,</span>
            <span class=n>fullFileName</span>   <span class=o>=</span> <span class=s2>&#34;${safeBuildName}.tar.gz&#34;</span><span class=o>,</span>
            <span class=n>applicationZip</span> <span class=o>=</span> <span class=s2>&#34;${artifactFolder}/${fullFileName}&#34;</span>
            <span class=n>applicationDir</span> <span class=o>=</span> <span class=o>[</span><span class=s2>&#34;app&#34;</span><span class=o>,</span>
                              <span class=s2>&#34;config&#34;</span><span class=o>,</span>
                              <span class=s2>&#34;Dockerfile&#34;</span><span class=o>,</span>
                              <span class=o>]</span><span class=o>.</span><span class=na>join</span><span class=o>(</span><span class=s2>&#34; &#34;</span><span class=o>)</span><span class=o>;</span>
        <span class=kt>def</span> <span class=n>needTargetPath</span> <span class=o>=</span> <span class=o>!</span><span class=n>fileExists</span><span class=o>(</span><span class=s2>&#34;${artifactFolder}&#34;</span><span class=o>)</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>needTargetPath</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>sh</span> <span class=s2>&#34;mkdir ${artifactFolder}&#34;</span>
        <span class=o>}</span>
        <span class=n>sh</span> <span class=s2>&#34;tar -czvf ${applicationZip} ${applicationDir}&#34;</span>
        <span class=n>archiveArtifacts</span> <span class=nl>artifacts:</span> <span class=s2>&#34;${applicationZip}&#34;</span><span class=o>,</span> <span class=nl>excludes:</span> <span class=kc>null</span><span class=o>,</span>               <span class=nl>onlyIfSuccessful:</span> <span class=kc>true</span>
      <span class=o>}</span>
  <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>We will be using <a href=https://jenkins.io/doc/book/pipeline/syntax/#script>script</a> to execute our instructions. Script console is basically for running arbitrary commands inside it.</p><h3 id=step-5-create-build-configuration-in-openshift>Step 5: create build configuration in OpenShift<a href=#step-5-create-build-configuration-in-openshift class=hanchor arialabel=Anchor> <svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg>&#xFE0E;</a></h3><p>After Step 4, we will have a nice compressed file containing what we need for building our app in openshift. Before start building the app, we need to have a Build Configuration inside OpenShift App.
Basically <a href=https://docs.openshift.com/container-platform/3.4/dev_guide/builds/index.html#dev-guide-what-is-a-build>Build Configuration</a> is sort of a skeleton which contains instructions on how your source will be build. There are many strategies for build config. We will be using <code>Docker</code> strategy for building our code. That is why we have put the <strong>Dockerfile</strong> inside our compressed file.
In build config, you need to provide from which source you want to build your code from. We will be using <code>binary</code>. Meaning we will provide a compressed file to openshift so that it can start building the image from it.</p><div class=highlight><pre class=chroma><code class=language-groovy data-lang=groovy><span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Create Image Builder&#39;</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>when</span> <span class=o>{</span>
        <span class=n>expression</span> <span class=o>{</span>
            <span class=n>openshift</span><span class=o>.</span><span class=na>withCluster</span><span class=o>(</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>openshift</span><span class=o>.</span><span class=na>withProject</span><span class=o>(</span><span class=n>DEV_PROJECT</span><span class=o>)</span> <span class=o>{</span>
                <span class=k>return</span> <span class=o>!</span><span class=n>openshift</span><span class=o>.</span><span class=na>selector</span><span class=o>(</span><span class=s2>&#34;bc&#34;</span><span class=o>,</span> <span class=s2>&#34;${TEMPLATE_NAME}&#34;</span><span class=o>)</span><span class=o>.</span><span class=na>exists</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>
                <span class=o>}</span>
            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span>
    <span class=n>steps</span> <span class=o>{</span>
        <span class=n>script</span> <span class=o>{</span>
            <span class=n>openshift</span><span class=o>.</span><span class=na>withCluster</span><span class=o>(</span><span class=o>)</span> <span class=o>{</span>
                <span class=n>openshift</span><span class=o>.</span><span class=na>withProject</span><span class=o>(</span><span class=n>DEV_PROJECT</span><span class=o>)</span> <span class=o>{</span>
                    <span class=n>openshift</span><span class=o>.</span><span class=na>newBuild</span><span class=o>(</span><span class=s2>&#34;--name=${TEMPLATE_NAME}&#34;</span><span class=o>,</span> <span class=s2>&#34;--docker-image=docker.io/nginx:mainline-alpine&#34;</span><span class=o>,</span> <span class=s2>&#34;--binary=true&#34;</span><span class=o>)</span>
                <span class=o>}</span>
            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>This stage of pipeline will only execute once when the pipeline is executed for first time. Later when pipeline is executed for second time, third time&mldr; and so on, this stage will be skipped. Because build configuration is made only once. You can check if a build configuration is being created using <code>oc get bc</code> in <strong>terminal</strong> (in project <strong>dev</strong>) from your local machine. You can also check it using web interface of openshift in <em>CI/CD projects > Builds</em>.
<code>openshift.withCluster</code> and <code>openshift.withProject</code> is basically openshift APIs open to <a href=https://github.com/openshift/jenkins-plugin>Jenkins plugin</a>. Using these APIs, you can execute commands inside openshift cluster and projects. Our <a href=https://www.mankier.com/1/oc-new-build>new-build</a> command is being executed inside <code>DEV_PROJECT</code>. Value of <code>DEV_PROJECT</code> is defined in environment variable, and the value is <code>dev</code>.</p><p><strong>NB</strong>: <em>Build Config</em>, <em>Deployment Config</em>, <em>Service</em>, <em>Image</em>, <em>Storage</em> etc are Kubernetes basics. These terms will come more frequently in next stages. If you have some idea about them, it might help you to understand this tutorial even more. ðŸ˜„</p><h3 id=step-6-build-image>Step 6: build image<a href=#step-6-build-image class=hanchor arialabel=Anchor> <svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg>&#xFE0E;</a></h3><p>Outcome of a successful build is an Image. So after a successful build, you will see an image inside OpenShift in web interface(at <em>OpenShift_Url > console > DEV Project > browse > images</em>). The most recent build outcomes to image tagged by <em>latest</em>. This is an important information, which will come handy in our next steps.
In our <em>build configuration</em>(defined in last step), we configured that the build will executed from binary. Meaning if will expect a archive file to start the build process. As we have a archive file from step 4, we will use that file for this purpose.</p><div class=highlight><pre class=chroma><code class=language-groovy data-lang=groovy><span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Build Image&#39;</span><span class=o>)</span> <span class=o>{</span>
  <span class=n>steps</span> <span class=o>{</span>
      <span class=n>script</span> <span class=o>{</span>
          <span class=n>openshift</span><span class=o>.</span><span class=na>withCluster</span><span class=o>(</span><span class=o>)</span> <span class=o>{</span>
          <span class=n>openshift</span><span class=o>.</span><span class=na>withProject</span><span class=o>(</span><span class=n>env</span><span class=o>.</span><span class=na>DEV_PROJECT</span><span class=o>)</span> <span class=o>{</span>
              <span class=n>openshift</span><span class=o>.</span><span class=na>selector</span><span class=o>(</span><span class=s2>&#34;bc&#34;</span><span class=o>,</span> <span class=s2>&#34;$TEMPLATE_NAME&#34;</span><span class=o>)</span><span class=o>.</span><span class=na>startBuild</span><span class=o>(</span><span class=s2>&#34;--from-archive=${ARTIFACT_FOLDER}/${APPLICATION_NAME}_${BUILD_NUMBER}.tar.gz&#34;</span><span class=o>,</span> <span class=s2>&#34;--wait=true&#34;</span><span class=o>)</span>
              <span class=o>}</span>
          <span class=o>}</span>
      <span class=o>}</span>
  <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p><code>openshift.selector</code> selects the build config named <code>python-nginx</code> (this value is set in <code>${TEMPLATE_NAME}</code>). Using that build config, it initiates a build from the <strong>tar.gz</strong> file. After the build is complete, you will see an image named <code>python-nginx</code> and it should be tagged as <em>latest</em>.</p><h3 id=step-7-deploy-to-openshift-in-dev>Step 7: deploy to OpenShift in DEV<a href=#step-7-deploy-to-openshift-in-dev class=hanchor arialabel=Anchor> <svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg>&#xFE0E;</a></h3><p>In this stage, we will deploy the image to <strong>DEV_PROJECT</strong>. Basically a <a href=https://docs.openshift.com/enterprise/3.0/dev_guide/deployments.html#creating-a-deployment-configuration>Deployment Configuration</a> is created in this step. Deployment Configuration is kind of like Build Config, but this is related to deployment. We will be using <a href=https://docs.openshift.com/enterprise/3.1/dev_guide/new_app.html#specifying-an-image>new-app</a> to create our project from image built in last stage.</p><div class=highlight><pre class=chroma><code class=language-groovy data-lang=groovy><span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Deploy to DEV&#39;</span><span class=o>)</span> <span class=o>{</span>
  <span class=n>when</span> <span class=o>{</span>
      <span class=n>expression</span> <span class=o>{</span>
        <span class=n>openshift</span><span class=o>.</span><span class=na>withCluster</span><span class=o>(</span><span class=o>)</span> <span class=o>{</span>
          <span class=n>openshift</span><span class=o>.</span><span class=na>withProject</span><span class=o>(</span><span class=n>env</span><span class=o>.</span><span class=na>DEV_PROJECT</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>return</span> <span class=o>!</span><span class=n>openshift</span><span class=o>.</span><span class=na>selector</span><span class=o>(</span><span class=s1>&#39;dc&#39;</span><span class=o>,</span> <span class=s2>&#34;${TEMPLATE_NAME}&#34;</span><span class=o>)</span><span class=o>.</span><span class=na>exists</span><span class=o>(</span><span class=o>)</span>
            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span>
  <span class=o>}</span>
  <span class=n>steps</span> <span class=o>{</span>
    <span class=n>script</span> <span class=o>{</span>
        <span class=n>openshift</span><span class=o>.</span><span class=na>withCluster</span><span class=o>(</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>openshift</span><span class=o>.</span><span class=na>withProject</span><span class=o>(</span><span class=n>env</span><span class=o>.</span><span class=na>DEV_PROJECT</span><span class=o>)</span> <span class=o>{</span>
                <span class=kt>def</span> <span class=n>app</span> <span class=o>=</span> <span class=n>openshift</span><span class=o>.</span><span class=na>newApp</span><span class=o>(</span><span class=s2>&#34;${TEMPLATE_NAME}:latest&#34;</span><span class=o>)</span>
                <span class=n>app</span><span class=o>.</span><span class=na>narrow</span><span class=o>(</span><span class=s2>&#34;svc&#34;</span><span class=o>)</span><span class=o>.</span><span class=na>expose</span><span class=o>(</span><span class=s2>&#34;--port=${PORT}&#34;</span><span class=o>)</span><span class=o>;</span>
                <span class=kt>def</span> <span class=n>dc</span> <span class=o>=</span> <span class=n>openshift</span><span class=o>.</span><span class=na>selector</span><span class=o>(</span><span class=s2>&#34;dc&#34;</span><span class=o>,</span> <span class=s2>&#34;${TEMPLATE_NAME}&#34;</span><span class=o>)</span>
                <span class=k>while</span> <span class=o>(</span><span class=n>dc</span><span class=o>.</span><span class=na>object</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>spec</span><span class=o>.</span><span class=na>replicas</span> <span class=o>!</span><span class=o>=</span> <span class=n>dc</span><span class=o>.</span><span class=na>object</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>status</span><span class=o>.</span><span class=na>availableReplicas</span><span class=o>)</span> <span class=o>{</span>
                    <span class=n>sleep</span> <span class=mi>10</span>
                  <span class=o>}</span>
              <span class=o>}</span>
          <span class=o>}</span>
      <span class=o>}</span>
  <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>This step is executed only in first time execution of pipeline. In next pipeline builds, this stage is skipped. But still, a deployment will be automatically done after each build is completed successfully. Because of <a href=https://docs.openshift.com/container-platform/3.3/dev_guide/deployments/basic_deployment_operations.html#image-change-trigger>Image Change Trigger</a>. Meaning, after each new image, an automated deployment will initiate. New deployment means, it will generate new pods and will destroy the old pods. There are two strategies for this change, <a href=https://docs.openshift.com/container-platform/3.3/dev_guide/deployments/deployment_strategies.html#rolling-strategy>rolling strategy</a> and <a href=https://docs.openshift.com/container-platform/3.3/dev_guide/deployments/deployment_strategies.html#recreate-strategy>recreate strategy</a>.
<code>app.narrow("svc").expose("--port=${PORT}");</code> this command will use the <strong>service</strong> built by <code>new-app</code>; then expose its <strong>route</strong> to port 8081, this value is set in Environment variable as well. You can see the new service and ports as well using <code>oc get svc</code> and <code>oc get routes</code> in <strong>dev</strong> project from your local machine.</p><h3 id=step-8-promote-image-to-stage>Step 8: promote image to STAGE<a href=#step-8-promote-image-to-stage class=hanchor arialabel=Anchor> <svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg>&#xFE0E;</a></h3><p>In this stage, jenkins will prompt you to promote or abort regarding if you want to continue deployment to <strong>stage</strong> project or not. If you click in promote(in Jenkins), then openshift promote the image created in step 6 to stage and tag it as <code>promoteToQA</code>(as per defined in environment).</p><div class=highlight><pre class=chroma><code class=language-groovy data-lang=groovy><span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Promote to STAGE?&#39;</span><span class=o>)</span> <span class=o>{</span>
  <span class=n>steps</span> <span class=o>{</span>
      <span class=n>timeout</span><span class=o>(</span><span class=nl>time:</span><span class=mi>15</span><span class=o>,</span> <span class=nl>unit:</span><span class=s1>&#39;MINUTES&#39;</span><span class=o>)</span> <span class=o>{</span>
           <span class=n>input</span> <span class=nl>message:</span> <span class=s2>&#34;Promote to STAGE?&#34;</span><span class=o>,</span> <span class=nl>ok:</span> <span class=s2>&#34;Promote&#34;</span>
      <span class=o>}</span>
      <span class=n>script</span> <span class=o>{</span>
          <span class=n>openshift</span><span class=o>.</span><span class=na>withCluster</span><span class=o>(</span><span class=o>)</span> <span class=o>{</span>
          <span class=n>openshift</span><span class=o>.</span><span class=na>tag</span><span class=o>(</span><span class=s2>&#34;${DEV_PROJECT}/${TEMPLATE_NAME}:latest&#34;</span><span class=o>,</span> <span class=s2>&#34;${STAGE_PROJECT}/${TEMPLATE_NAME}:${STAGE_TAG}&#34;</span><span class=o>)</span>
            <span class=o>}</span>
        <span class=o>}</span>
   <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><h3 id=step-9-deploy-to-openshift-in-stage>Step 9: deploy to OpenShift in STAGE<a href=#step-9-deploy-to-openshift-in-stage class=hanchor arialabel=Anchor> <svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg>&#xFE0E;</a></h3><p>In this step, we will be looking if any previous deployment is done in STAGE PROJECT. If it exists, then we will delete <em>service</em>, <em>route</em>, <em>deployment config</em> of that deployment, and create a new app using the new image promoted in last step. Then will expose the route for this application in 8081 port.</p><div class=highlight><pre class=chroma><code class=language-groovy data-lang=groovy><span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Rollout to STAGE&#39;</span><span class=o>)</span> <span class=o>{</span>
  <span class=n>steps</span> <span class=o>{</span>
      <span class=n>script</span> <span class=o>{</span>
            <span class=n>openshift</span><span class=o>.</span><span class=na>withCluster</span><span class=o>(</span><span class=o>)</span> <span class=o>{</span>
              <span class=n>openshift</span><span class=o>.</span><span class=na>withProject</span><span class=o>(</span><span class=n>STAGE_PROJECT</span><span class=o>)</span> <span class=o>{</span>
                  <span class=k>if</span> <span class=o>(</span><span class=n>openshift</span><span class=o>.</span><span class=na>selector</span><span class=o>(</span><span class=s1>&#39;dc&#39;</span><span class=o>,</span> <span class=s1>&#39;${TEMPLATE_NAME}&#39;</span><span class=o>)</span><span class=o>.</span><span class=na>exists</span><span class=o>(</span><span class=o>)</span><span class=o>)</span> <span class=o>{</span>
                      <span class=n>openshift</span><span class=o>.</span><span class=na>selector</span><span class=o>(</span><span class=s1>&#39;dc&#39;</span><span class=o>,</span> <span class=s1>&#39;${TEMPLATE_NAME}&#39;</span><span class=o>)</span><span class=o>.</span><span class=na>delete</span><span class=o>(</span><span class=o>)</span>
                      <span class=n>openshift</span><span class=o>.</span><span class=na>selector</span><span class=o>(</span><span class=s1>&#39;svc&#39;</span><span class=o>,</span> <span class=s1>&#39;${TEMPLATE_NAME}&#39;</span><span class=o>)</span><span class=o>.</span><span class=na>delete</span><span class=o>(</span><span class=o>)</span>
                       <span class=n>openshift</span><span class=o>.</span><span class=na>selector</span><span class=o>(</span><span class=s1>&#39;route&#39;</span><span class=o>,</span> <span class=s1>&#39;${TEMPLATE_NAME}&#39;</span><span class=o>)</span><span class=o>.</span><span class=na>delete</span><span class=o>(</span><span class=o>)</span>
                <span class=o>}</span>
            <span class=n>openshift</span><span class=o>.</span><span class=na>newApp</span><span class=o>(</span><span class=s2>&#34;${TEMPLATE_NAME}:${STAGE_TAG}&#34;</span><span class=o>)</span><span class=o>.</span><span class=na>narrow</span><span class=o>(</span><span class=s2>&#34;svc&#34;</span><span class=o>)</span><span class=o>.</span><span class=na>expose</span><span class=o>(</span><span class=s2>&#34;--port=${PORT}&#34;</span><span class=o>)</span>
            <span class=o>}</span>
         <span class=o>}</span>
      <span class=o>}</span>
  <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><h3 id=step-10-scale-in-stage>Step 10: scale in STAGE<a href=#step-10-scale-in-stage class=hanchor arialabel=Anchor> <svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg>&#xFE0E;</a></h3><p>We will be using <a href=https://jenkins.io/doc/pipeline/steps/openshift-pipeline/#openshiftscale-scale-openshift-deployment>openshiftScale</a> API provided by Jenkins OpenShift Plugin. What it does is that, it creates replication of pods according the number of replication information provided to it via parameter <code>replicaCount</code>.</p><div class=highlight><pre class=chroma><code class=language-groovy data-lang=groovy><span class=n>stage</span><span class=o>(</span><span class=s1>&#39;Scale in STAGE&#39;</span><span class=o>)</span> <span class=o>{</span>
  <span class=n>steps</span> <span class=o>{</span>
      <span class=n>script</span> <span class=o>{</span>
          <span class=n>openshiftScale</span><span class=o>(</span><span class=nl>namespace:</span> <span class=s2>&#34;${STAGE_PROJECT}&#34;</span><span class=o>,</span> <span class=nl>deploymentConfig:</span> <span class=s2>&#34;${TEMPLATE_NAME}&#34;</span><span class=o>,</span> <span class=nl>replicaCount:</span> <span class=s1>&#39;3&#39;</span><span class=o>)</span>
        <span class=o>}</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p><em>FYI: This API will be deprecated from oc version 3.11</em>
This is the last step of our pipeline. Lets save it in a file named <strong>Jenkinsfile</strong>. <em>Please commit and push your changes to your Git repository</em>.</p><p>The Jenkins file should look like <a href=https://raw.githubusercontent.com/ruddra/openshift-python-nginx/master/openshift/pipelines/Jenkinsfile>this</a>.</p><h2 id=conclusion>Conclusion<a href=#conclusion class=hanchor arialabel=Anchor> <svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg>&#xFE0E;</a></h2><p>Lets discuss more about how to deploy our application using this pipeline in <a href=https://ruddra.com/openshift-python-gunicorn-nginx-jenkins-pipelines-part-three>next article</a>.</p><p>Feel free to comment if you find anything unclear. Thanks for reading.
Cheers!!</p></div><br><p><a class=tag-class href=/tags/openshift>OpenShift</a> <a class=tag-class href=/tags/jenkins>Jenkins</a> <a class=tag-class href=/tags/pipeline>Pipeline</a> <a class=tag-class href=/tags/ci/cd>CI/CD</a></p><div class=newsletter-section id=newsletter-submitted><h2>Get Better With OpenShift</h2><div id=commento class="commento-root commento-root-font"><div id=newsletter-error class=commento-error-box style=display:none>An error occurred when submitting the form, please try again.</div><div id=newsletter-submitted-box style=display:none><p class=newsletter-submitted-txt>Thank you for your subscription to our newsletters.<br>You will start receiving emails from next iteration.</p></div><div id=newsletter-body><div>Subscribe to get monthly articles about OpenShift and more.<br>We won't spam you. Unsubscribe at any time.</div><br><div id=commento-main-area class=commento-main-area><form id=commento-form method=post action=https://ruddra-comments.netlify.app/.netlify/functions/server/v2/entry/ruddra/ruddra.comments/master/comments><input type=hidden name=options[redirect] value=https://ruddra.com/posts/openshift-python-gunicorn-nginx-jenkins-pipelines-part-two/#newsletter-submitted>
<input type=hidden name=options[slug] value=newsletter-subscription>
<input type=hidden name=options[parent] value=newsletter-subscription>
<input type=hidden name=options[origin] value=https://ruddra.com/newsletters/>
<input type=hidden name=options[redirectError] value=https://ruddra.com/posts/openshift-python-gunicorn-nginx-jenkins-pipelines-part-two/#newsletter-error><div id=commento-login class=commento-login><input type=email name=fields[email] placeholder="My email address is ..." style="padding-left:10px;width:90%;line-height:2;border:1px solid rgba(50,50,93,.1)" required></div><div style=width:95.8%><button id=commento-submit-button-root type=submit class="commento-button commento-submit-button">Subscribe</button><div class="commento-round-check commento-anonymous-checkbox-container"><input id=commento-checkbox-root name=options[subscribe] type=checkbox value=email required><label for=commento-checkbox-root>I agree to receive
emails</label></div></div></form></div></div></div></div><div class=pagination><div class="pagination-item older"><span class=pagination-arrow>&#8592; Previous</span><div class=pagination-link><a href=https://ruddra.com/posts/openshift-python-gunicorn-nginx-jenkins-pipelines-part-one/>Deploy A Python App to OpenShift: Planning and Preparations</a></div><div class=pagination-image><img src=https://ruddra.com/content/images/2019/02/openshift-jenkins-python-nginx.jpg alt="Deploy A Python App to OpenShift: Planning and Preparations"></div><p class=pagination-text>Deploying a Python application to OpenShift is fairly easy. Write a Dockerfile and run oc new-app /path/to/Dockerfile, â€¦</p></div><div class="pagination-item newer"><span class=pagination-arrow>Next &#8594;</span><div class=pagination-link><a href=https://ruddra.com/posts/openshift-python-gunicorn-nginx-jenkins-pipelines-part-three/>Automated Deployment to OpenShift Using Jenkins and Webhook</a></div><div class=pagination-image><img src=https://ruddra.com/content/images/2020/04/hook.jpg alt="Automated Deployment to OpenShift Using Jenkins and Webhook" decoding=async loading=lazy></div><p class=pagination-text>The last post was about defining the pipelines. Now it is time to execute them. Also, at the end, we are going to show â€¦</p></div></div><div class=tiny id=comment-submitted><div id=commento class="commento-root commento-root-font"><div id=comment-submitted-box style=display:none><h3>Thank you for your comment. It will be published in few minutes.</h3><br></div><div id=comment-error style=display:none><h3>An error occurred when submitting the form, please try again.</h3><br></div><div id=commento-mod-tools class=commento-mod-tools style=display:none><button id=commento-mod-tools-lock-button>Lock Thread</button></div><div id=commento-main-area class=commento-main-area><form id=comment-form method=post name=comment-form onsubmit=submitComment(event)><input type=hidden name=options[redirect] value=https://ruddra.com/posts/openshift-python-gunicorn-nginx-jenkins-pipelines-part-two/#comment-submitted>
<input type=hidden name=options[slug] value=openshift-python-gunicorn-nginx-jenkins-pipelines-part-two>
<input type=hidden name=options[parent] value=openshift-python-gunicorn-nginx-jenkins-pipelines-part-two>
<input type=hidden name=options[origin] value=https://ruddra.com/posts/openshift-python-gunicorn-nginx-jenkins-pipelines-part-two/>
<input type=hidden id=comment-parent name=fields[reply_to]>
<input type=hidden name=options[redirectError] value=https://ruddra.com/posts/openshift-python-gunicorn-nginx-jenkins-pipelines-part-two/#comment-error><div id=commento-logged-container class=commento-logged-container><div class=commento-name id=comment-headline><b>Share Your Thoughts</b></div></div><div class=commento-logout></div></div><div id=commento-textarea-super-container-root class=commento-button-margin><div id=commento-textarea-container-root class=commento-textarea-container><textarea name=fields[comment] id=commento-textarea-root placeholder="Add a comment" required></textarea></div><button id=commento-submit-button-root type=submit class="commento-button commento-submit-button submit-github">Comment With Github</button><div class="commento-round-check commento-anonymous-checkbox-container"><input id=commento-anonymous-checkbox-root name=options[subscribe] type=checkbox value=email><label for=commento-anonymous-checkbox-root>Notify me of new comments</label></div><a onclick=toggleMarkDownTable() id=commento-markdown-button-root class=commento-markdown-button><b>M
â†“</b> &nbsp; Markdown</a><table id=commento-markdown-help-root class=commento-markdown-help style=display:none><tr><td><i>italics</i></td><td>surround text with<code>*asterisks*</code></td></tr><tr><td><b>bold</b></td><td>surround text with<code>**two asterisks**</code></td></tr><tr><td><a href=https://example.com>hyperlink</a></td><td><code>[hyperlink](https://example.com)</code> or just a bare URL</td></tr><tr><td><code>code</code></td><td>surround text with
<code>`backticks`</code></td></tr><tr><td><code>code block</code></td><td>surround text with
<code>```console.log()```</code></td></tr><tr><td><strike>strikethrough</strike></td><td>surround text with
<code>~~two tilde characters~~</code></td></tr><tr><td><blockquote>quote</blockquote></td><td>prefix with
<code>></code></td></tr><tr><td>Emoji ðŸ˜±</td><td><b>:smile:</b>ðŸ˜„ <b>:angry:</b>ðŸ˜ 
<b>:disappointed:</b>ðŸ˜ž
etc.(<a href=https://www.webfx.com/tools/emoji-cheat-sheet/>emoji cheat
sheet</a>)</td></tr></table></div><p id=commneto-renderer-msg></p></form><div id=commento-comments-area class=commento-comments></div></div></div></div></div><script src=https://ruddra.com/js/bundle.min.5605e63704d3549ca6c14e2910fc0ccf10a712a10c78ecc1f39af3392b1ec633.js async></script></div></div><label for=sidebar-checkbox class=sidebar-toggle></label><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-58095062-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body><script>function showPrivacy(){if(localStorage.getItem("cookieSeen")!="shown"){var x=document.getElementById("snackbar");x.className="show";localStorage.setItem("cookieSeen","shown")}}
showPrivacy();function closePrivacy(){var fadeTarget=document.getElementById("snackbar");var fadeEffect=setInterval(function(){if(!fadeTarget.style.opacity){fadeTarget.style.opacity=1;}
if(fadeTarget.style.opacity>0){fadeTarget.style.opacity-=0.1;}else{clearInterval(fadeEffect);}},50);}
document.getElementById("close-privacy").addEventListener('click',closePrivacy);</script></html>